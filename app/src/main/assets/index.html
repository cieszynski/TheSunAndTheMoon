<!DOCTYPE html>
<html lang="de">

<head>
    <title>The Sun &amp; The Moon</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <style>
        @font-face {
            font-family: "roboto";
            font-weight: normal;
            font-style: normal;
            src: url('Roboto-Regular.ttf') format('truetype');
        }

        @font-face {
            font-family: "material-icons";
            src: url(data:font/truetype;charset=utf-8;base64,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Xw889QAfCAAAAAAA0t6jygAAAADbKfnwAAAAAAdUB1QAAAAIAAIAAAAAAAAAAQAACAL/2AAACAAAAAAAB1QAAQAAAAAAAAAAAAAAAAAAABIC7ABEAAAAAAKqAAADqgAAB1QAAAOqAAAHVAAAAnEAAAHVAAABOAAAATgAAADqAAABdwAAAGgAAAF3AAAB1QAAB9AAAAgAAKwArAAAAAAALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAA0AGAAsgABAAAAEwAQAAMAAAAAAAIAAQACABYAAAEAAFwAAAAAAAAADACWAAMAAQQJAAAAYAAAAAMAAQQJAAEAHABgAAMAAQQJAAIADgB8AAMAAQQJAAMAUgCKAAMAAQQJAAQALADcAAMAAQQJAAUAGgEIAAMAAQQJAAYAKgEiAAMAAQQJAMgAFgFMAAMAAQQJAMkAMAFiAAMAAQQJAMoADgGSAAMAAQQJAMsABgGgAAMAAQQJ2QMAGgGmAEMAbwBwAHkAcgBpAGcAaAB0ACAAMgAwADEANQAgAEcAbwBvAGcAbABlACwAIABJAG4AYwAuACAAQQBsAGwAIABSAGkAZwBoAHQAcwAgAFIAZQBzAGUAcgB2AGUAZAAuAE0AYQB0AGUAcgBpAGEAbAAgAEkAYwBvAG4AcwBSAGUAZwB1AGwAYQByAEYAbwBuAHQARgBvAHIAZwBlACAAMgAuADAAIAA6ACAATQBhAHQAZQByAGkAYQBsACAASQBjAG8AbgBzACAAOgAgADgALQAyAC0AMgAwADEANgBNAGEAdABlAHIAaQBhAGwAIABJAGMAbwBuAHMAIABSAGUAZwB1AGwAYQByAFYAZQByAHMAaQBvAG4AIAAxAC4AMAAxADEATQBhAHQAZQByAGkAYQBsAEkAYwBvAG4AcwAtAFIAZQBnAHUAbABhAHIAVwBlAGIAZgBvAG4AdAAgADEALgAwAFQAdQBlACAASgB1AGwAIAAgADcAIAAxADAAOgAwADcAOgA0ADUAIAAyADAAMgAwAGQAZQBmAGEAdQBsAHQAbABlAG8ARgBvAG4AdAAgAFMAcQB1AGkAcgByAGUAbAAAAAIAAAAAAAD6JADIAAAAAAAAAAAAAAAAAAAAAAAAAAAAEwAAAQIBAwEEAQUBBgEHAQgBCQEKAQsBDAENAQ4BDwEQAREBEgETBmdseXBoMQZnbHlwaDIHdW5pMjAwMAd1bmkyMDAxB3VuaTIwMDIHdW5pMjAwMwd1bmkyMDA0B3VuaTIwMDUHdW5pMjAwNgd1bmkyMDA3B3VuaTIwMDgHdW5pMjAwOQd1bmkyMDBBB3VuaTIwMkYHdW5pMjA1Rgd1bmkyNUZDB3VuaUU4OEEHdW5pRTg4RQAAuAH/hbABjQBLsAhQWLEBAY5ZsUYGK1ghsBBZS7AUUlghsIBZHbAGK1xYWbAUKwAA) format('truetype');
            font-weight: normal;
            font-style: normal;

        }

        * {
            font-family: "roboto";
            box-sizing: border-box;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        }

        *:focus {
            outline: none;
        }

        html,
        body {
            padding: 0;
            margin: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #edf0f2;
        }

        main {
            overflow: hidden;
            position: relative;
            width: 100%;
            height: 100%;
        }

        article,
        aside {
            overflow-y: scroll;
            position: absolute;
            opacity: 0;
            top: 100vh;
            left: 0;
            transition: top .3s, opacity .3s;
            will-change: top, opacity;
            width: 100%;
            height: 100%;
        }

        nav.rail {
            width: 100%;
            height: 56px;
            background-color: #344955;
            display: flex;
            flex-direction: row;
            align-content: space-between;
            justify-content: center;
        }

        label.rail {
            display: inline-flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 56px;
            width: 100%;
            max-width: 144px;
            color: #b4c1cc;
        }

        .material-icon {
            font: 20px "material-icons";
            display: inline-block;
        }

        .rail-text {
            display: inline-block;
        }

        .card {
            border-radius: 8px;
            background-color: #fff;
            margin: 8px;
            overflow: hidden;
        }

        div.card {
            padding: 16px;
        }

        .item {
            display: flex;
        }

        hr {
            border: 1px solid #b4c1cc;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 8px 8px 0 0;
            width: 100%;
            height: 100%;
        }


        .aspect-ratio {
            position: relative;
            overflow: hidden;
            height: 0;
            padding-top: 60%;
        }

        div.info {
            display: flex;
        }

        div.info label {
            margin: 8px;
            text-align: center;
            display: inline-block;
            width: 100%;
        }


        table {
            width: 100%;
        }

        td.date {
            vertical-align: top;
            width: 56px;
        }

        output[name="day"] {
            text-align: center;
            display: block;
            font-size: 30px;
            font-weight: bold;
        }

        output[name="month"] {
            display: block;
            text-align: center;
        }

        .center {
            text-align: center;
            width: 56px;
        }

        .right {
            text-align: right;
        }

        dialog {
            text-align: center;
            border: none;
            box-shadow: 10px 5px 5px gray;
        }

        input[name="rail"]:nth-of-type(2):checked~* label.rail:nth-of-type(2),
        input[name="rail"]:nth-of-type(1):checked~* label.rail:nth-of-type(1) {
            color: #f9aa33;
        }

        input[name="rail"]:nth-of-type(2):checked~* aside,
        input[name="rail"]:nth-of-type(1):checked~* article {
            opacity: 1;
            top: 0;
        }

        @media (orientation: landscape),
        (min-width: 800px) {
            body {
                flex-direction: row-reverse;
            }

            nav.rail {
                width: 56px;
                height: 100vh;
                flex-direction: column;
                justify-content: flex-start;
            }

            .rail-text {
                display: none;
            }
        }

        @media (min-width: 800px) {
            nav.rail {
                width: 72px;
            }

            .card {
                max-width: 800px;
                margin: 8px auto;
            }
        }

        @media (min-width: 1116px) {
            nav.rail {
                width: 300px;
                padding: 16px;
            }

            label.rail {
                display: inline-flex;
                flex-direction: row;
                justify-content: flex-start;
                align-items: center;
            }

            .material-icon {
                width: 36px;
            }

            .rail-text {
                display: inline-block;
            }
        }

        @keyframes slidein {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        dialog.busy {
            padding: 4px;
            top: calc(50vh - 25px);
            width: 50px;
            height: 50px;
            animation: .8s infinite linear slidein;
            box-shadow: 0px 0px 10px;
            border-radius: 50px;
            border: 10px solid #fff;
            background-origin: border-box;
            background-clip: content-box, border-box;
            background-image: linear-gradient(#fff, #fff), radial-gradient(circle at top left, #fff, #fff 50%, #344955 50%, #344955);
        }
    </style>
    <template>
        <form class="card item">
            <table>
                <tbody>
                    <tr>
                        <td rowspan="3" class="center">
                            <output name="day"></output>
                            <output name="month"></output>
                        </td>
                    </tr>
                    <tr>
                        <td class="right">Sonne</td>
                        <td><output name="sun_rise">--:--</output></td>
                        <td>(<output name="sun_rise_az"></output>°)</td>
                        <td><output name="sun_set">--:--</output></td>
                        <td>(<output name="sun_set_az"></output>°)</td>
                    </tr>
                    <tr>
                        <td class="right">Mond</td>
                        <td><output name="moon_rise">--:--</output></td>
                        <td>(<output name="moon_rise_az"></output>°)</td>
                        <td><output name="moon_set">--:--</output></td>
                        <td>(<output name="moon_set_az"></output>°)</td>
                    </tr>
                </tbody>
            </table>
        </form>
    </template>
</head>

<body>
    <form id="data"></form>
    <input type="radio" name="rail" id="a" hidden checked />
    <input type="radio" name="rail" id="b" hidden />
    <main>
        <article>
            <form class="card">
                <div class="aspect-ratio">
                    <canvas></canvas>
                </div>
                <div class="info">
                    <label>Lat: <output name="lat" form="data"></output>°</label>
                    <label>Lon: <output name="lon" form="data"></output>°</label>
                    <label>N: <output name="alpha" form="data"></output>°</label>
                </div>
                <div class="info">
                    <label>Vollmond: <output name="fullmoon" form="data"></output></label>
                </div>
            </form>
        </article>
        <aside>
            <div class="card">
                <picture>
                    <source srcset="ic_launcher192.png" media="(min-width: 800px)">
                    <source srcset="ic_launcher144.png" media="(min-width: 600px)">
                    <img src="ic_launcher96.png" alt="">
                </picture>
                <p>Die Sonne &amp; Der Mond</p>
                <p>Stephan Cieszynski (developer@cieszynski.de)</p>
                <hr />
                <p>Mit dieser Anwendung ist es möglich, weltweit die Zeiten von Sonnenaufgang, Sonnenuntergang,
                    Mondaufgang und Monduntergang am jeweiligen Standort zu ermitteln. Zusätzlich zu den Zeiten
                    (Ortszeit) wird auch die Richtung am Horizont angezeigt, in der die Sonne oder der Mond auf- bzw.
                    untergeht - besonders interessant für die Landschaftsfotografie. Norden ist bei 0° (Ausrichtung vom
                    Gerät ist herstellerabhängig).
                </p>
                <P>Alle Angaben erfolgen für den aktuellen Tag und die nächsten zwei Wochen. Eine zeitliche Beschränkung
                    hat die Anwendung nicht.
                </P>
                <p>Die Anwendung funktioniert offline und enthält keine Werbung oder In-App-Käufe.
                    Als Berechtigung ist lediglich der Zugriff auf den Standort notwendig, was beim ersten Start der
                    Anwendung abgefragt wird.
                </p>
            </div>
            <div class="card">Version 1.0</div>
        </aside>
    </main>
    <nav class="rail">
        <label for="a" class="rail"><span class="material-icon">&#xe88a;</span><span
                class="rail-text">Home</span></label>
        <label for="b" class="rail"><span class="material-icon">&#xe88e;</span><span
                class="rail-text">Info</span></label>
    </nav>
    <dialog>
        <form method="dialog">
            <p>Kein Standort abrufbar</p>
            <button>OK</button>
        </form>
    </dialog>

    <dialog class="busy rounded-corners-gradient-borders" open>

    </dialog>
</body>

<script src="epherem.js"></script>
<script src="sun.js"></script>
<script src="moon.js"></script>
<script>
    'use strict';
    const canvas = document.querySelector('canvas');
    const dialog = document.querySelector('dialog');
    const busy = document.querySelector('dialog.busy');
    const article = document.querySelector('article');
    const template = document.querySelector('template');
    const output = document.forms.data.elements;

    const month = ["Jan", "Feb", "Mär", "Apr", "Mai", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dez"]

    const sun = new Sun();
    const moon = new Moon();

    let dirty = false;
    let timeout = null;
    let lat = 0;
    let lon = 0;
    let today = new Date();

    const draw_sun = function (ctx, w, h, jd) {
        ctx.save();
        const rradec = sun.rradec(jd);
        const azal = sun.azal(jd, lat * rad, lon * rad, rradec.ra, rradec.dec);
        h -= 15 // skylines height
        let r = 15, s1 = 5, s2 = 20;
        let x = (w / 2) - (cos(azal.az - 90 * rad) * (w / 2 - (r + s2)));
        let y = h - (r + s2) - ((h - 2 * (r + s2)) / 90 * azal.al * deg);
        // y -= 60; // skylines height
        ctx.lineWidth = 6;
        ctx.strokeStyle = 'yellow';
        ctx.beginPath();
        for (let i = 0; i < 6; i++) {
            ctx.translate(x, y)
            ctx.rotate(rad * 60);
            ctx.translate(-x, -y)
            ctx.moveTo(x + r + s1, y);
            ctx.lineTo(x + r + s2, y);
        }
        ctx.moveTo(x + r, y)
        ctx.arc(x, y, r, 0, 2 * PI);
        ctx.closePath();
        ctx.stroke();
        ctx.restore()
    }

    const draw_moon = function (ctx, w, h, jd) {
        ctx.save();
        const rradec = moon.rradec(jd);
        const azal = moon.azal(jd, lat * rad, lon * rad, rradec.ra, rradec.dec);
        const age = moon.age(jd);
        h -= 15 // skylines height
        let s = 6;
        let r = 30;
        let x = (w / 2) - (Math.cos(azal.az - 90 * rad) * (w / 2 - r));
        let y = h - r - ((h - 2 * r) / 90 * azal.al * deg);
        let a = (age <= 0.5)
            ? age * 160 - 40
            : (age - 0.5) * 160 - 40;
        // y -= 60; // skylines height
        ctx.translate(x, y)
        ctx.rotate(rad * (90 + lat))
        ctx.translate(-x, -y)
        ctx.lineWidth = s;
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        ctx.strokeStyle = 'white';
        ctx.beginPath();
        ctx.arc(x, y, r, -PI / 2, PI / 2, (age <= 0.5))
        ctx.bezierCurveTo(x + a, y + r + s / 2, x + a, y - r - s / 2, x, y - r);
        // ctx.closePath();
        ctx.stroke();

        ctx.restore()
    }

    const draw_sky = function (ctx, w, h, jd) {
        const sun = new Sun();
        const rradec = sun.rradec(jd);
        const azal = sun.azal(jd, lat * rad, lon * rad, rradec.ra, rradec.dec);

        if (azal.al * deg > -6 && azal.al * deg < 6) {
            const r = 25 + (135 - 25) / 12 * (azal.al * deg + 6);
            const g = 25 + (206 - 25) / 12 * (azal.al * deg + 6);
            const b = 112 + (250 - 112) / 12 * (azal.al * deg + 6);
            ctx.fillStyle = `rgb(${r}, ${g}, ${b}`;
        } else {
            if (azal.al * deg > 6) {
                ctx.fillStyle = `rgb(135, 206, 250`; // #87CEFA
            }

            if (azal.al * deg < -6) {
                ctx.fillStyle = `rgb(25, 25, 112`; // #191970
            }
        }

        ctx.fillRect(0, 0, w, h);
    }

    const img = new Image();
    img.src = 'skyline.svg';

    const draw_skyline = function (ctx, w, h) {
        ctx.drawImage(img, 0, 20, w, h);
        img.onload = function () {
            ctx.drawImage(img, 0, 20, w, h);
        }
    }

    const get_rise_set = function (o, i) {
        const now = new Date();
        now.setDate(now.getDate() + i);
        const tz = now.getTimezoneOffset() / -60;
        let jd = JD(
            now.getUTCFullYear(),
            now.getUTCMonth() + 1,
            now.getUTCDate());
        const riseset = o.riseset(jd, tz, lat * rad, lon * rad);

        const hhmmss_rise = hhmmss(riseset.hhrise);
        const hr = hhmmss_rise[0], mr = hhmmss_rise[1], sr = hhmmss_rise[2];
        now.setHours(hr)
        now.setMinutes(mr)
        now.setSeconds(sr)

        jd = JD(
            now.getUTCFullYear(),
            now.getUTCMonth() + 1,
            now.getUTCDate(),
            now.getUTCHours(),
            now.getUTCMinutes(),
            now.getUTCSeconds());
        const rradec_rise = o.rradec(jd);
        const azal_rise = o.azal(jd, lat * rad, lon * rad, rradec_rise.ra, rradec_rise.dec);

        const hhmmss_set = hhmmss(riseset.hhset);
        const hs = hhmmss_set[0], ms = hhmmss_set[1], ss = hhmmss_set[2];
        now.setHours(hs)
        now.setMinutes(ms)
        now.setSeconds(ss)

        jd = JD(
            now.getUTCFullYear(),
            now.getUTCMonth() + 1,
            now.getUTCDate(),
            now.getUTCHours(),
            now.getUTCMinutes(),
            now.getUTCSeconds());
        const rradec_set = o.rradec(jd);
        const azal_set = o.azal(jd, lat * rad, lon * rad, rradec_set.ra, rradec_set.dec);

        return {
            hhrise: riseset.hhrise,
            azr: azal_rise.az,
            hhset: riseset.hhset,
            azs: azal_set.az,
            day: now
        };
    }

    function draw() {
        output.namedItem("lat").value = lat.toFixed(2);
        output.namedItem("lon").value = lon.toFixed(2);

        const now = new Date();

        const jd = JD(
            now.getUTCFullYear(),
            now.getUTCMonth() + 1,
            now.getUTCDate(),
            now.getUTCHours(),
            now.getUTCMinutes(),
            now.getUTCSeconds());

        const ctx = canvas.getContext('2d');
        const width = canvas.clientWidth;
        canvas.width = width;
        const height = canvas.clientHeight;
        canvas.height = height;

        draw_sky(ctx, width, height, jd);
        draw_moon(ctx, width, height, jd);
        draw_sun(ctx, width, height, jd);
        draw_skyline(ctx, width, height);

        const fm = DATE(moon.fullmoon(jd));
        output.namedItem("fullmoon").value = `${('0' + fm.getDate()).slice(-2)}.${('0' + (fm.getMonth() + 1)).slice(-2)}.${fm.getFullYear()} - ${('0' + fm.getHours()).slice(-2)}:${('0' + fm.getMinutes()).slice(-2)}`//new Intl.DateTimeFormat({dateStyle: 'full'}).format(fullmoon);

        dirty = (now - today) > 86400000;
        if (busy.open) busy.close();
    }

    navigator.geolocation.watchPosition(
        function (result) {
            dirty = (Math.abs(lat - result.coords.latitude) > 1 || (Math.abs(lon - result.coords.longitude) > 1));
            lat = result.coords.latitude;
            lon = result.coords.longitude;

            if (dialog.open)
                dialog.close();

            if (dirty) {
                const items = article.querySelectorAll('form.item');
                for (let i = 0; i < items.length; i++) {
                    const rs_sun = get_rise_set(sun, i);
                    const rs_moon = get_rise_set(moon, i);

                    items[i].elements.namedItem('day').value = rs_sun.day.getDate();
                    items[i].elements.namedItem('month').value = month[rs_sun.day.getMonth()];
                    items[i].elements.namedItem('sun_rise').value = hhmm(rs_sun.hhrise);
                    items[i].elements.namedItem('sun_rise_az').value = (rs_sun.azr * deg).toFixed(0);
                    items[i].elements.namedItem('sun_set').value = hhmm(rs_sun.hhset);
                    items[i].elements.namedItem('sun_set_az').value = (rs_sun.azs * deg).toFixed(0);
                    items[i].elements.namedItem('moon_rise').value = (rs_moon.hhrise) ? hhmm(rs_moon.hhrise) : '--:--';
                    items[i].elements.namedItem('moon_rise_az').value = (rs_moon.hhrise) ? (rs_moon.azr * deg).toFixed(0) : '--';
                    items[i].elements.namedItem('moon_set').value = (rs_moon.hhset) ? hhmm(rs_moon.hhset) : '--:--';
                    items[i].elements.namedItem('moon_set_az').value = (rs_moon.hhset) ? (rs_moon.azs * deg).toFixed(0) : '--';;
                };
            }
            requestAnimationFrame(draw);
        },
        function (error) {
            switch (error.code) {
                case 0: // GeolocationPositionError.PERMISSION_DENIED:
                case 1: // GeolocationPositionError.POSITION_UNAVAILABLE:
                case 2: // GeolocationPositionError.TIMEOUT:
                    console.error(error.code);
            }

            if (!dialog.open)
                dialog.showModal();
            dirty = true;
            requestAnimationFrame(draw);
        }
    );

    for (let k = 0; k < 14; k++) {
        article.appendChild(template.content.cloneNode(true));
    }

    window.addEventListener('resize', function (e) {
        requestAnimationFrame(draw);
    });

    window.addEventListener('deviceorientation', function (e) {
        let alpha = 360 - e.alpha;
        alpha += (alpha < 0) ? 360 : 0;
        output.namedItem("alpha").value = alpha.toFixed(2);
    });
</script>

</html>